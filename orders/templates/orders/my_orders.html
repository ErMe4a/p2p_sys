{% extends 'base.html' %}
{% load l10n %}

{% block content %}

<style>
    /* –í–ê–ñ–ù–û: –ú—ã —É–¥–∞–ª–∏–ª–∏ :root –∏ body –æ—Ç—Å—é–¥–∞, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–ª–∏—Å—å –∏–∑ base.html.
       –¢–µ–ø–µ—Ä—å —Ü–≤–µ—Ç–∞ –±–µ—Ä—É—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ–º—ã.
    */

    /* === –ö–û–ù–¢–ï–ô–ù–ï–†–´ === */
    .form-section { background: var(--bg-card); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 20px; }
    .table-container { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }

    /* === –°–¢–ò–õ–ò –§–û–†–ú–´ === */
    .form-label {
        color: var(--text-muted);
        font-size: 12px;
        margin-bottom: 6px;
        display: block;
    }

    .form-control, .form-select {
        background-color: var(--bg-input) !important; /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π */
        border: 1px solid var(--border-color) !important;
        color: var(--text-main) !important;
        font-size: 14px;
        border-radius: 6px;
        height: 42px; 
        padding: 8px 12px;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--accent-blue) !important;
        box-shadow: 0 0 0 2px rgba(61, 90, 254, 0.2);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã –∫–æ–º–∏—Å—Å–∏–∏ */
    .commission-group { display: flex; }
    .commission-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; }
    .commission-select { 
        width: 70px; 
        background-color: rgba(61, 90, 254, 0.1) !important; 
        border: 1px solid var(--border-color) !important; 
        color: var(--accent-blue) !important; 
        font-weight: bold; 
        text-align: start;
        border-top-left-radius: 0; 
        border-bottom-left-radius: 0;
        cursor: pointer;
    }

    /* === –¢–ê–ë–õ–ò–¶–ê === */
    .table { margin-bottom: 0; color: var(--text-main); font-size: 13px; }
    .table thead th { background: rgba(255,255,255,0.02); color: var(--text-muted); border-bottom: 1px solid var(--border-color); padding: 12px 15px; font-size: 11px; text-transform: uppercase; vertical-align: middle; }
    .table td { border-bottom: 1px solid var(--border-color); padding: 10px 15px; vertical-align: middle; }

    /* === –ö–ù–û–ü–ö–ò === */
    .btn-create { 
        background-color: var(--accent-blue); 
        color: #fff; 
        border: none; 
        height: 42px; 
        border-radius: 6px; 
        width: 100%; 
        font-weight: 600; 
        margin-top: 23px; 
    }
    .btn-create:hover { background-color: #304ffe; }

    /* –ë–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ */
    .btn-action { background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); font-size: 12px; padding: 4px 10px; border-radius: 4px; transition: 0.2s; cursor: pointer; }
    .btn-action:hover { background: var(--border-color); }
    .btn-delete { background: #3d2428; border: 1px solid #5a2d2d; color: #ff8080; }
    
    .status-buy { color: var(--success); font-weight: 600; }
    .status-sell { color: var(--danger); font-weight: 600; }
    .badge-exchange { background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border-color); font-size: 11px; padding: 4px 8px; border-radius: 4px; }

    /* === –ú–û–î–ê–õ–ö–ê === */
    .modal-content { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); }
    .modal-header { border-bottom: 1px solid var(--border-color); }
    .modal-footer { border-top: none; }
    /* –ò–Ω–≤–µ—Ä—Å–∏—è –∫—Ä–µ—Å—Ç–∏–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    [data-bs-theme="dark"] .btn-close { filter: invert(1); }
    
    .btn-save-modal { background-color: var(--accent-blue); color: white; border-radius: 6px; border: none; font-weight: 600; }
    .btn-cancel-modal { background-color: var(--bg-input); color: var(--text-main); border-radius: 6px; border: 1px solid var(--border-color); font-weight: 600; }
</style>

<div class="form-section">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="row mb-3">
            <div class="col-12">
                <input type="text" name="external_id" class="form-control" placeholder="–ù–æ–º–µ—Ä –æ—Ä–¥–µ—Ä–∞">
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-2">
                <input type="text" name="price" class="form-control" placeholder="–ö—É—Ä—Å">
            </div>
            <div class="col-md-2">
                <input type="text" name="amount" class="form-control" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
            </div>
            <div class="col-md-2">
                <input type="text" name="cost" class="form-control" placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å">
            </div>
            <div class="col-md-3">
                <select class="form-select" name="operation_type">
                    <option value="BUY">–ü–æ–∫—É–ø–∫–∞</option>
                    <option value="SELL">–ü—Ä–æ–¥–∞–∂–∞</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="exchange">
                    <option value="Bybit">Bybit</option>
                    <option value="HTX">HTX</option>
                    <option value="MEXC">MEXC</option>
                </select>
            </div>
        </div>

        <div class="row g-3 align-items-start">
            <div class="col-md-3">
                <select class="form-select" name="details">
                    <option selected disabled value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫...</option>
                    {% for bank in default_banks %}<option value="{{ bank }}">{{ bank }}</option>{% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <div class="commission-group">
                    <input type="number" name="commission_value" class="form-control" step="1" placeholder="0">
                    <select class="form-select commission-select" name="commission_type">
                        <option value="PERCENT">%</option>
                        <option value="RUB">‚ÇΩ</option>
                    </select>
                </div>
            </div>
            
            <div class="col-md-3">
                <input type="datetime-local" name="created_at" class="form-control" value="{{ current_time }}">
            </div>
            
            <div class="col-md-2 pt-4"> 
                <div class="d-flex gap-3 align-items-center h-100 ps-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkDocs" name="need_receipt">
                        <label class="form-check-label small text-muted" for="checkDocs">–ß–µ–∫</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkScreen" name="use_screen">
                        <label class="form-check-label small text-muted" for="checkScreen">–°–∫—Ä–∏–Ω</label>
                    </div>
                </div>
            </div>
            
            <div class="col-md-2">
                <button type="submit" name="create_order" class="btn btn-create">–°–æ–∑–¥–∞—Ç—å –æ—Ä–¥–µ—Ä</button>
            </div>
        </div>

        <div id="fileInputWrapper" class="mt-3" style="display: none;">
            <label class="form-label">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç</label>
            <input type="file" name="screenshot" class="form-control">
        </div>
    </form>
</div>

<div class="table-container shadow-sm">
    <table class="table">
        <thead>
            <tr>
                <th>ID</th><th>–¢–∏–ø</th><th>–ë–∏—Ä–∂–∞</th><th>–ö—É—Ä—Å</th><th>–ö–æ–ª-–≤–æ</th><th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th><th>–ö–æ–º–∏—Å.</th><th>–¢–∏–ø</th><th>‚Ññ –û—Ä–¥–µ—Ä–∞</th><th>–°–æ–∑–¥–∞–Ω</th><th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            
            {% with order_date=order.created_at|date:"Y-m-d" order_time=order.created_at|date:"H:i" formatted_price=order.price|floatformat:"-8"|unlocalize formatted_amount=order.amount|floatformat:"-8"|unlocalize formatted_cost=order.cost|floatformat:"-8"|unlocalize formatted_comm=order.commission|floatformat:"-8"|unlocalize %}
            
            <tr>
                <td class="fw-bold">{{ order.id }}</td>
                <td class="{% if order.operation_type == 'BUY' %}status-buy{% else %}status-sell{% endif %}">{{ order.get_operation_type_display }}</td>
                <td><span class="badge badge-exchange">{{ order.exchange_type }}</span></td>
                
                <td>{{ formatted_price }}</td>
                <td>{{ formatted_amount }}</td>
                <td>{{ formatted_cost }}</td>
                <td>{{ formatted_comm }}</td>
                
                <td class="text-muted">{% if order.commission_type == 'PERCENT' %}%{% else %}‚ÇΩ{% endif %}</td>
                <td class="text-muted small">{{ order.external_id|truncatechars:15 }}</td>
                <td class="small text-muted" style="line-height: 1.2;">
                    {{ order_date }}<br>{{ order_time }}
                </td>
                <td>
                    <div class="d-flex gap-1 justify-content-end align-items-center">
                        <button class="btn btn-action" 
                            onclick="openEditModal(
                                '{{ order.id }}', 
                                '{{ order.operation_type }}', 
                                '{{ order.exchange_type }}', 
                                '{{ order.bank_detail.name|escapejs }}', 
                                '{{ formatted_price }}', 
                                '{{ formatted_amount }}', 
                                '{{ formatted_cost }}', 
                                '{{ formatted_comm }}', 
                                '{{ order.commission_type }}', 
                                '{{ order.external_id|escapejs }}', 
                                '{{ order_date }}T{{ order_time }}'
                            )">
                            –ò–∑–º.
                        </button>

                        <button class="btn btn-action" onclick="triggerUpload('{{ order.id }}')" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å/–ó–∞–º–µ–Ω–∏—Ç—å">üì∑</button>
                        
                        <form id="upload-form-{{ order.id }}" action="{% url 'upload_screenshot' order.id %}" method="post" enctype="multipart/form-data" style="display: none;">
                            {% csrf_token %}
                            <input type="file" id="file-input-{{ order.id }}" name="screenshot" accept="image/*,application/pdf" onchange="document.getElementById('upload-form-{{ order.id }}').submit();">
                        </form>

                        {% if order.screenshot %}
                            <a href="{{ order.screenshot.url }}" target="_blank" class="btn btn-action text-decoration-none" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å">üëÅÔ∏è</a>
                        {% endif %}

                        <a href="{% url 'delete_order' order.id %}" class="btn btn-action btn-delete" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å?')">–£–¥–∞–ª–∏—Ç—å</a>
                    </div>
                </td>
            </tr>
            
            {% endwith %}
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg" style="border-radius: 12px;">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞ #<span id="display_id"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
                            <select class="form-select" name="operation_type" id="modal_op_type"><option value="BUY">–ü–æ–∫—É–ø–∫–∞</option><option value="SELL">–ü—Ä–æ–¥–∞–∂–∞</option></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ë–∏—Ä–∂–∞</label>
                            <select class="form-select" name="exchange" id="modal_exchange"><option value="Bybit">Bybit</option><option value="HTX">HTX</option><option value="MEXC">MEXC</option></select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">–†–µ–∫–≤–∏–∑–∏—Ç—ã</label>
                            <select class="form-select" name="details" id="modal_details">{% for bank in default_banks %}<option value="{{ bank }}">{{ bank }}</option>{% endfor %}</select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ö—É—Ä—Å</label>
                            <input type="text" name="price" id="modal_price" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <input type="text" name="amount" id="modal_amount" class="form-control">
                        </div>
                        <div class="col-12">
                            <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</label>
                            <input type="text" name="cost" id="modal_cost" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ö–æ–º–∏—Å—Å–∏—è</label>
                            <div class="commission-group">
                                <input type="number" name="commission_value" id="modal_comm_val" class="form-control" step="0.1">
                                <select class="form-select commission-select" name="commission_type" id="modal_comm_type"><option value="PERCENT">%</option><option value="RUB">‚ÇΩ</option></select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ù–æ–º–µ—Ä –æ—Ä–¥–µ—Ä–∞</label>
                            <input type="text" name="external_id" id="modal_ext_id" class="form-control">
                        </div>
                        <div class="col-12">
                            <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                            <input type="datetime-local" name="created_at" id="modal_date" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer pb-3 pt-3 justify-content-between">
                    <button type="button" class="btn btn-cancel-modal px-4 py-2" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-save-modal px-4 py-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // –ü–æ–∫–∞–∑ –ø–æ–ª—è –¥–ª—è —Ñ–∞–π–ª–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
    document.getElementById('checkScreen').addEventListener('change', function() {
        document.getElementById('fileInputWrapper').style.display = this.checked ? 'block' : 'none';
    });

    function openEditModal(id, opType, exchange, details, price, amount, cost, commVal, commType, extId, date) {
        document.getElementById('editForm').action = "/edit/" + id + "/";
        document.getElementById('display_id').innerText = id;

        const detailsSelect = document.getElementById('modal_details');
        detailsSelect.value = details;

        if (detailsSelect.value !== details && details !== 'None' && details !== '') {
            let newOpt = new Option(details, details);
            detailsSelect.add(newOpt);
            detailsSelect.value = details;
        }

        document.getElementById('modal_op_type').value = opType;
        document.getElementById('modal_exchange').value = exchange;
        document.getElementById('modal_price').value = price;
        document.getElementById('modal_amount').value = amount;
        document.getElementById('modal_cost').value = cost;
        document.getElementById('modal_comm_val').value = commVal;
        document.getElementById('modal_comm_type').value = commType;
        document.getElementById('modal_ext_id').value = extId;
        document.getElementById('modal_date').value = date; 
        
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    // –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
    function triggerUpload(orderId) {
        const fileInput = document.getElementById('file-input-' + orderId);
        if (fileInput) fileInput.click();
    }
</script>
{% endblock %}
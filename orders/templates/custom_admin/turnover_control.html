{% extends 'custom_admin/admin_base.html' %}

{% block title %}–ö–æ–Ω—Ç—Ä–æ–ª—å –æ–±–æ—Ä–æ—Ç–∞{% endblock %}

{% block extra_css %}
<style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ü–≤–µ—Ç–∞ –∏–∑ —Ç–≤–æ–µ–≥–æ –¥–∏–∑–∞–π–Ω–∞ */
    :root { --bg:#0f1115; --card:#151923; --text:#e6e8ee; --muted:#99a1b3; --accent:#6c8cff; --danger:#ff6c6c; --ok:#58d68d; --border:#242a36; --warn:#ffc107; }
    
    /* –£–±–∏—Ä–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–±—Ä–æ—Å—ã, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –∞–¥–º–∏–Ω–∫—É, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∫–ª–∞—Å—Å—ã */
    .card-custom { background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow: 0 0 0 1px var(--border), 0 10px 28px rgba(108,140,255,.06); }
    
    .btn { appearance:none; border:1px solid var(--border); background:#1a2030; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; transition:all .15s ease; font-size:14px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; height:36px; }
    .btn:hover { border-color:#2e3650; transform:translateY(-1px); }
    .btn.primary { background:linear-gradient(180deg, #2a365f, #1f2a4a); border-color:#33406b; }
    .btn.primary:hover { box-shadow: 0 0 14px rgba(108,140,255,.25); }
    .btn.danger { background:linear-gradient(180deg, #5f2a2a, #4a1f1f); border-color:#6b3333; color:#ffdede; }
    .btn.sm { padding:6px 10px; font-size:12px; border-radius:8px; height:28px; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

    .input { width:100%; padding:9px 12px; background:#111520; border:1px solid var(--border); color:var(--text); border-radius:10px; font-size:13px; transition:all .15s ease; }
    .input:focus { outline:none; box-shadow: 0 0 0 2px rgba(108,140,255,.25); border-color:#3c4b7a; }

    /* –°–µ–∫—Ü–∏–∏ */
    .form-section { background:#111520; border-radius:10px; padding:16px; margin-bottom:16px; border:1px solid var(--border); }
    .form-section h4 { color:var(--text); margin-bottom:12px; font-size:13px; font-weight:600; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px; }
    .form-group label { display:block; margin-bottom:6px; color:var(--muted); font-size:12px; font-weight:500; }

    /* –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    .user-search-container { position:relative; }
    .user-dropdown { position:absolute; top:100%; left:0; right:0; background:var(--card); border:1px solid var(--border); border-radius:10px; margin-top:4px; max-height:250px; overflow-y:auto; z-index:100; display:none; box-shadow:0 10px 30px rgba(0,0,0,.3); }
    .user-dropdown.active { display:block; }
    .user-option { padding:10px 14px; cursor:pointer; transition:all .15s ease; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; }
    .user-option:hover { background:#1a2030; }
    .user-avatar { width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg, var(--accent), #4a5fd6); display:flex; align-items:center; justify-content:center; font-weight:600; color:white; font-size:13px; }
    .user-login { font-weight:500; color:var(--text); font-size:13px; }
    .user-id { font-size:11px; color:var(--muted); }

    /* –í—ã–±—Ä–∞–Ω–Ω—ã–π —é–∑–µ—Ä */
    .selected-user-badge { display:none; align-items:center; gap:10px; background:#111520; border:1px solid var(--border); padding:12px 16px; border-radius:10px; margin-top:12px; }
    .selected-user-badge.active { display:flex; }
    .selected-user-name { font-weight:500; color:var(--accent); font-size:14px; }
    .selected-user-id { font-size:12px; color:var(--muted); }

    /* –ö–Ω–æ–ø–∫–∏ –¥–∞—Ç */
    .quick-dates { display:flex; gap:8px; margin-top:16px; flex-wrap:wrap; }
    .quick-date-btn { background:#111520; border:1px solid var(--border); color:var(--muted); padding:8px 14px; font-size:13px; border-radius:8px; cursor:pointer; transition:all .15s ease; }
    .quick-date-btn:hover { border-color:#2e3650; color:var(--text); }
    .quick-date-btn.active { background:rgba(108,140,255,.15); border-color:rgba(108,140,255,.3); color:var(--accent); }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∏—Ç–æ–≥–æ–≤ */
    .summary-cards { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:24px; }
    .summary-card { background:#111520; border-radius:10px; padding:20px; border:1px solid var(--border); position:relative; overflow:hidden; }
    .summary-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
    .summary-card.buy::before { background:linear-gradient(90deg, var(--ok), #3cb371); }
    .summary-card.sell::before { background:linear-gradient(90deg, var(--danger), #ff8c66); }
    .summary-card.total::before { background:linear-gradient(90deg, var(--accent), #4a5fd6); }
    .summary-card.profit::before { background:linear-gradient(90deg, var(--warn), #ffb347); }
    .summary-title { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
    .summary-value { font-size:1.5rem; font-weight:300; margin-bottom:4px; }
    .summary-count { font-size:12px; color:var(--muted); }

    /* –¢–∞–±–ª–∏—Ü—ã */
    .tables-container { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .table-section { background:#111520; border-radius:10px; overflow:hidden; border:1px solid var(--border); }
    .table-header { padding:14px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
    .table-header.buy { background:rgba(88,214,141,.05); }
    .table-header.sell { background:rgba(255,108,108,.05); }
    .table-title { font-size:14px; font-weight:500; display:flex; align-items:center; gap:8px; }
    .table-header.buy .table-title { color:var(--ok); }
    .table-header.sell .table-title { color:var(--danger); }
    .table { width:100%; border-collapse:separate; border-spacing:0; }
    .table th, .table td { padding:10px 12px; text-align:left; border-bottom:1px solid var(--border); font-size:13px; color:var(--muted); }
    .table th { color:#b6bed2; font-weight:600; background:#121622; }
    .amount-cell { font-weight:500; font-family:monospace; }
    .buy-amount { color:var(--ok); }
    .sell-amount { color:var(--danger); }
    .no-data { text-align:center; padding:40px 20px; color:var(--muted); }
    .no-data-icon { font-size:32px; margin-bottom:10px; opacity:0.5; }
    .period-info { background:rgba(255,193,7,.1); border:1px solid rgba(255,193,7,.2); border-radius:8px; padding:10px 16px; margin-bottom:20px; font-size:13px; color:var(--warn); text-align:center; }
    .timezone-info { background:rgba(108,140,255,.1); border:1px solid rgba(108,140,255,.2); border-radius:8px; padding:8px 14px; margin-top:16px; font-size:12px; color:var(--accent); display:inline-block; }
    .hidden { display:none !important; }

    @media (max-width: 1000px) { .tables-container { grid-template-columns:1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="section">
    <div class="form-section">
        <h4>–í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
        <div class="user-search-container">
            <input type="text" id="userSearch" class="input" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." autocomplete="off">
            <div id="userDropdown" class="user-dropdown"></div>
        </div>
        
        <div id="selectedUserBadge" class="selected-user-badge">
            <div class="user-avatar" id="selectedAvatar">-</div>
            <div class="selected-user-info" style="flex:1;">
                <div class="selected-user-name" id="selectedUserName">-</div>
                <div class="selected-user-id" id="selectedUserId">ID: -</div>
            </div>
            <button class="btn sm danger" onclick="clearUserSelection()">‚úï –°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div class="timezone-info" id="timezoneInfo">üïê –ú–æ—Å–∫–≤–∞: –ó–∞–≥—Ä—É–∑–∫–∞...</div>

        <div class="quick-dates">
            <button type="button" class="quick-date-btn active" onclick="setToday()">–°–µ–≥–æ–¥–Ω—è</button>
            <button type="button" class="quick-date-btn" onclick="setYesterday()">–í—á–µ—Ä–∞</button>
            <button type="button" class="quick-date-btn" onclick="setLastWeek()">–ù–µ–¥–µ–ª—è</button>
            <button type="button" class="quick-date-btn" onclick="setLastMonth()">–ú–µ—Å—è—Ü</button>
        </div>

        <div class="form-row">
            <div class="form-group" style="margin-bottom:0;">
                <label for="startDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                <input class="input" type="date" id="startDate">
            </div>
            <div class="form-group" style="margin-bottom:0;">
                <label for="endDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                <input class="input" type="date" id="endDate">
            </div>
        </div>

        <button id="loadBtn" class="btn primary" onclick="loadTurnover()" disabled style="width:100%; margin-top:16px; height:42px;">
            üìà –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–æ—Ä–æ—Ç
        </button>
        
        <div id="loadError" class="error hidden" style="margin-top:12px;"></div>
    </div>

    <div id="resultsSection" class="hidden">
        <div class="period-info" id="periodInfo">üìÖ –ü–µ—Ä–∏–æ–¥: –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã</div>
        
        <div class="summary-cards">
            <div class="summary-card buy">
                <div class="summary-title">–ü–æ–∫—É–ø–∫–∏ (BUY)</div>
                <div class="summary-value" id="buyTotal">0 ‚ÇΩ</div>
                <div class="summary-count"><span id="buyCount">0</span> –æ–ø–µ—Ä–∞—Ü–∏–π</div>
            </div>
            <div class="summary-card sell">
                <div class="summary-title">–ü—Ä–æ–¥–∞–∂–∏ (SELL)</div>
                <div class="summary-value" id="sellTotal">0 ‚ÇΩ</div>
                <div class="summary-count"><span id="sellCount">0</span> –æ–ø–µ—Ä–∞—Ü–∏–π</div>
            </div>
            <div class="summary-card total">
                <div class="summary-title">–û–±—â–∏–π –æ–±–æ—Ä–æ—Ç</div>
                <div class="summary-value" id="totalTurnover">0 ‚ÇΩ</div>
                <div class="summary-count"><span id="totalCount">0</span> –≤—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π</div>
            </div>
            <div class="summary-card profit">
                <div class="summary-title">–†–∞–∑–Ω–∏—Ü–∞ (SELL - BUY)</div>
                <div class="summary-value" id="profitValue">0 ‚ÇΩ</div>
                <div class="summary-count" id="profitLabel">–ë–∞–ª–∞–Ω—Å</div>
            </div>
        </div>

        <div class="tables-container">
            <div class="table-section">
                <div class="table-header buy">
                    <div class="table-title">‚ÜóÔ∏è –ü–æ–∫—É–ø–∫–∏ (BUY)</div>
                    <span class="badge ok" style="border-radius:20px;" id="buyTableCount">0 –∑–∞–ø–∏—Å–µ–π</span>
                </div>
                <div class="table-scroll">
                    <table class="table">
                        <thead><tr><th>ID</th><th>–°—É–º–º–∞</th><th>–ö–æ–ª-–≤–æ</th><th>–î–∞—Ç–∞</th></tr></thead>
                        <tbody id="buyOrdersTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="table-section">
                <div class="table-header sell">
                    <div class="table-title">‚ÜòÔ∏è –ü—Ä–æ–¥–∞–∂–∏ (SELL)</div>
                    <span class="badge danger" style="border-radius:20px;" id="sellTableCount">0 –∑–∞–ø–∏—Å–µ–π</span>
                </div>
                <div class="table-scroll">
                    <table class="table">
                        <thead><tr><th>ID</th><th>–°—É–º–º–∞</th><th>–ö–æ–ª-–≤–æ</th><th>–î–∞—Ç–∞</th></tr></thead>
                        <tbody id="sellOrdersTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- –õ–æ–≥–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ ---
    function updateMskTime() {
        const now = new Date();
        const options = { timeZone: 'Europe/Moscow', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' };
        document.getElementById('timezoneInfo').textContent = `üïê –ú–æ—Å–∫–≤–∞: ${new Intl.DateTimeFormat('ru-RU', options).format(now)}`;
    }
    setInterval(updateMskTime, 1000);
    updateMskTime();

    // --- –õ–æ–≥–∏–∫–∞ –¥–∞—Ç ---
    function setDate(daysBack) {
        const end = new Date();
        const start = new Date();
        start.setDate(start.getDate() - daysBack);
        
        document.getElementById('endDate').value = end.toISOString().split('T')[0];
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
    }

    function setToday() { 
        setDate(0); 
        setActiveBtn(0); 
    }
    function setYesterday() { 
        const d = new Date(); d.setDate(d.getDate() - 1);
        const str = d.toISOString().split('T')[0];
        document.getElementById('startDate').value = str;
        document.getElementById('endDate').value = str;
        setActiveBtn(1); 
    }
    function setLastWeek() { setDate(7); setActiveBtn(2); }
    function setLastMonth() { setDate(30); setActiveBtn(3); }

    function setActiveBtn(index) {
        document.querySelectorAll('.quick-date-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i === index);
        });
    }

    // --- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
    const userSearchInput = document.getElementById('userSearch');
    const userDropdown = document.getElementById('userDropdown');
    let selectedUserId = null;

    userSearchInput.addEventListener('input', async function() {
        const query = this.value.trim();
        if (query.length < 1) { 
            userDropdown.classList.remove('active'); 
            return; 
        }

        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Django URL –¥–ª—è –ø–æ–∏—Å–∫–∞
            const response = await fetch(`{% url 'api_search_users' %}?q=${query}`);
            const users = await response.json();

            if (users.length > 0) {
                userDropdown.innerHTML = users.map(user => `
                    <div class="user-option" onclick="selectUser(${user.id}, '${user.username}')">
                        <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                        <div class="user-info-dropdown">
                            <div class="user-login"><strong>${user.username}</strong></div>
                            <div class="user-id">ID: ${user.id}</div>
                        </div>
                    </div>
                `).join('');
                userDropdown.classList.add('active');
            } else {
                userDropdown.innerHTML = '<div class="user-option" style="cursor:default">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                userDropdown.classList.add('active');
            }
        } catch (e) {
            console.error(e);
        }
    });

    // –°–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.user-search-container')) userDropdown.classList.remove('active');
    });

    function selectUser(id, login) {
        selectedUserId = id;
        document.getElementById('selectedUserName').textContent = login;
        document.getElementById('selectedUserId').textContent = `ID: ${id}`;
        document.getElementById('selectedAvatar').textContent = login.charAt(0).toUpperCase();
        
        document.getElementById('selectedUserBadge').classList.add('active');
        document.getElementById('loadBtn').disabled = false;
        
        userSearchInput.value = login;
        userDropdown.classList.remove('active');
    }

    function clearUserSelection() {
        selectedUserId = null;
        userSearchInput.value = '';
        document.getElementById('selectedUserBadge').classList.remove('active');
        document.getElementById('loadBtn').disabled = true;
        document.getElementById('resultsSection').classList.add('hidden');
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–æ—Ä–æ—Ç–∞ ---
    async function loadTurnover() {
        if (!selectedUserId) return;
        
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const btn = document.getElementById('loadBtn');
        const errorDiv = document.getElementById('loadError');
        
        btn.innerHTML = '<span class="loading-spinner"></span>–ó–∞–≥—Ä—É–∑–∫–∞...';
        btn.disabled = true;
        errorDiv.classList.add('hidden');

        try {
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL. –í–∞–∂–Ω–æ: –ø–∞—Ä–∞–º–µ—Ç—Ä ID –ø–µ—Ä–µ–¥–∞–µ–º –≤ URL
            const url = `{% url 'api_get_turnover' 0 %}`.replace('0', selectedUserId) + `?start=${start}&end=${end}`;
            
            const response = await fetch(url);
            
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            
            const data = await response.json();
            renderData(data, start, end);
            
        } catch (e) {
            errorDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.';
            errorDiv.classList.remove('hidden');
            console.error(e);
        } finally {
            btn.innerHTML = 'üìà –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–æ—Ä–æ—Ç';
            btn.disabled = false;
        }
    }

    function renderData(data, start, end) {
        document.getElementById('resultsSection').classList.remove('hidden');
        
        // –ò–Ω—Ñ–æ –æ –ø–µ—Ä–∏–æ–¥–µ
        const totalCount = parseInt(data.buy_count) + parseInt(data.sell_count);
        document.getElementById('periodInfo').textContent = `üìÖ –ü–µ—Ä–∏–æ–¥: ${start} ‚Äî ${end} | –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${totalCount} –∑–∞–∫–∞–∑–æ–≤`;

        // –ö–∞—Ä—Ç–æ—á–∫–∏ (–¥–∞–Ω–Ω—ã–µ —É–∂–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
        document.getElementById('buyTotal').textContent = data.buy_sum + ' ‚ÇΩ';
        document.getElementById('buyCount').textContent = data.buy_count;
        
        document.getElementById('sellTotal').textContent = data.sell_sum + ' ‚ÇΩ';
        document.getElementById('sellCount').textContent = data.sell_count;
        
        document.getElementById('totalTurnover').textContent = data.total_sum + ' ‚ÇΩ';
        document.getElementById('totalCount').textContent = totalCount;
        
        const profitEl = document.getElementById('profitValue');
        profitEl.textContent = (parseFloat(data.profit.replace(/\s/g, '').replace(',', '.')) >= 0 ? '+' : '') + data.profit + ' ‚ÇΩ';
        profitEl.style.color = parseFloat(data.profit.replace(/\s/g, '').replace(',', '.')) >= 0 ? 'var(--ok)' : 'var(--danger)';

        // –¢–∞–±–ª–∏—Ü—ã
        renderTable('buyOrdersTable', data.buy_orders, 'buy');
        renderTable('sellOrdersTable', data.sell_orders, 'sell');
        
        document.getElementById('buyTableCount').textContent = `${data.buy_count} –∑–∞–ø–∏—Å–µ–π`;
        document.getElementById('sellTableCount').textContent = `${data.sell_count} –∑–∞–ø–∏—Å–µ–π`;
    }

    function renderTable(elementId, orders, type) {
        const tbody = document.getElementById(elementId);
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="no-data"><div class="no-data-icon">üì≠</div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
            return;
        }
        
        const amountClass = type === 'buy' ? 'buy-amount' : 'sell-amount';
        
        tbody.innerHTML = orders.map(o => `
            <tr>
                <td class="order-id-cell">${o.id}</td>
                <td class="amount-cell ${amountClass}">${parseFloat(o.amount).toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚ÇΩ</td>
                <td>${parseFloat(o.cost).toLocaleString('ru-RU', {maximumFractionDigits: 4})}</td>
                <td class="date-cell">${o.date}</td>
            </tr>
        `).join('');
    }

    // –°—Ç–∞–≤–∏–º –¥–∞—Ç—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = setToday;
</script>
{% endblock %}
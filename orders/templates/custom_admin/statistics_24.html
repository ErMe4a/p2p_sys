{% extends 'custom_admin/admin_base.html' %}
{% load l10n %}

{% block title %}API –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ 24—á{% endblock %}

{% block extra_css %}
<style>
    /* –õ–æ–∞–¥–µ—Ä */
    .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* –¢–≤–æ–∏ —Å—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞) */
    .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: var(--bg-card); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
    .stat-value { font-size: 1.4rem; font-weight: bold; color: #fff; }
    .filters-section { background: var(--bg-card); padding: 20px; border-radius: 10px; border: 1px solid var(--border-color); margin-bottom: 20px; }
    .filters-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
    .input { background: var(--bg-input); border: 1px solid var(--border-color); color: #fff; padding: 8px; border-radius: 4px; width: 100%; }
</style>
{% endblock %}

{% block content %}

<div id="loader" class="loader-overlay">
    <div class="text-center">
        <div class="spinner mb-3 mx-auto"></div>
        <div style="color:white; font-size: 1.2rem;">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Bybit...</div>
        <small style="color:#aaa;">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</small>
    </div>
</div>

<div class="section">
    <form method="GET" action="{% url 'admin_stats_24h' %}" onsubmit="document.getElementById('loader').style.display='flex'">
        <div class="filters-section">
            <div class="filters-row">
                <div style="flex: 1; min-width: 200px;">
                    <label style="color:#aaa; font-size:0.8rem;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                    <select name="user" class="input">
                        <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                        {% for u in users %}
                            <option value="{{ u.id }}" {% if current_user == u.id %}selected{% endif %}>
                                {{ u.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div style="flex: 1; min-width: 150px;">
                    <label style="color:#aaa; font-size:0.8rem;">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                    <select name="exchange" class="input">
                        <option value="">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</option>
                        <option value="1" {% if current_exchange == '1' %}selected{% endif %}>Bybit</option>
                        </select>
                </div>

                <div style="flex: 1; min-width: 150px;">
                    <label style="color:#aaa; font-size:0.8rem;">–¢–∏–ø</label>
                    <select name="type" class="input">
                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                        <option value="BUY" {% if current_type == 'BUY' %}selected{% endif %}>–ü–æ–∫—É–ø–∫–∞</option>
                        <option value="SELL" {% if current_type == 'SELL' %}selected{% endif %}>–ü—Ä–æ–¥–∞–∂–∞</option>
                    </select>
                </div>

                <div style="flex: 0 0 100px;">
                    <label style="color:#aaa; font-size:0.8rem;">–ö–æ–ª-–≤–æ</label>
                    <select name="limit" class="input">
                        <option value="25" {% if current_limit == '25' %}selected{% endif %}>25</option>
                        <option value="50" {% if current_limit == '50' %}selected{% endif %}>50</option>
                        <option value="100" {% if current_limit == '100' %}selected{% endif %}>100</option>
                    </select>
                </div>

                <div style="flex: 0 0 auto;">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100" style="background: var(--accent-blue); border:none; padding: 9px 20px;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            </div>
        </div>
    </form>

    <div class="stats-summary">
        <div class="stat-card">
            <div style="color:#aaa; font-size:0.8rem;">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
            <div class="stat-value">{{ total_orders }}</div>
        </div>
        <div class="stat-card">
            <div style="color:#aaa; font-size:0.8rem;">–ü–æ–∫—É–ø–∫–∏</div>
            <div class="stat-value" style="color:#00c087;">{{ buy_count }}</div>
        </div>
        <div class="stat-card">
            <div style="color:#aaa; font-size:0.8rem;">–ü—Ä–æ–¥–∞–∂–∏</div>
            <div class="stat-value" style="color:#f84960;">{{ sell_count }}</div>
        </div>
        <div class="stat-card">
            <div style="color:#aaa; font-size:0.8rem;">–û–±–æ—Ä–æ—Ç (Fiat)</div>
            <div class="stat-value" style="color:#3498db;">{{ total_amount|floatformat:0 }} ‚ÇΩ</div>
        </div>
    </div>

    <div class="table-container" style="background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border-color); overflow:hidden;">
        <table class="table mb-0" style="color: #ddd;">
            <thead style="background: rgba(255,255,255,0.05);">
                <tr>
                    <th>ID</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–¢–∏–ø</th>
                    <th>–ë–∏—Ä–∂–∞</th>
                    <th>–°—É–º–º–∞ (‚ÇΩ)</th>
                    <th>–ö—Ä–∏–ø—Ç–∞</th>
                    <th>–ö—É—Ä—Å</th>
                    <th>–í—Ä–µ–º—è</th>
                </tr>
            </thead>
            <tbody>
                {% if not is_search %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <h4 class="text-muted">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</h4>
                        </td>
                    </tr>
                {% else %}
                    {% for order in orders %}
                    <tr>
                        <td><small class="text-muted">{{ order.external_id|slice:"-8:" }}</small></td>
                        <td><strong>{{ order.user.username }}</strong></td>
                        <td>
                            {% if order.operation_type == 'BUY' %}
                                <span style="color:#00c087; font-weight:bold;">BUY</span>
                            {% else %}
                                <span style="color:#f84960; font-weight:bold;">SELL</span>
                            {% endif %}
                        </td>
                        <td>{{ order.exchange_type }}</td>
                        <td>{{ order.cost|floatformat:2 }} ‚ÇΩ</td>
                        <td>{{ order.amount|floatformat:4 }}</td>
                        <td>{{ order.price|floatformat:2 }}</td>
                        <td>{{ order.created_at|date:"H:i d.m" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>

        {% if orders.has_other_pages %}
        <div class="p-3 d-flex justify-content-center gap-2">
            {% if orders.has_previous %}
                <a href="?page={{ orders.previous_page_number }}&user={{ current_user }}&exchange={{ current_exchange }}&type={{ current_type }}&limit={{ current_limit }}" class="btn btn-sm btn-outline-secondary">‚Üê</a>
            {% endif %}
            <span class="btn btn-sm disabled text-white">{{ orders.number }} / {{ orders.paginator.num_pages }}</span>
            {% if orders.has_next %}
                <a href="?page={{ orders.next_page_number }}&user={{ current_user }}&exchange={{ current_exchange }}&type={{ current_type }}&limit={{ current_limit }}" class="btn btn-sm btn-outline-secondary">‚Üí</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% extends 'admin/admin_base.html' %}

{% block title %}–†–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–∫–∞–∑–æ–≤ | –ê–¥–º–∏–Ω–∫–∞{% endblock %}

{% block extra_css %}
<style>
    .form-section { background:#111520; border-radius:10px; padding:16px; margin-bottom:16px; border:1px solid var(--border-color); }
    .form-section h3 { color:var(--text-main); margin-bottom:16px; font-size:14px; font-weight:500; }
    .info-field { padding:10px 14px; background:rgba(108,140,255,.05); border:1px solid var(--border-color); border-radius:8px; font-size:13px; color:var(--text-main); font-family: monospace; word-break: break-all; }
    .form-row { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; }
    .form-group { margin-bottom:16px; }
    .form-group label { display:block; margin-bottom:6px; color:var(--text-muted); font-size:12px; font-weight:500; }
    
    .alert { padding: 10px 15px; border-radius: 8px; font-size: 13px; margin-bottom: 15px; border: 1px solid transparent; }
    .alert-success { background: rgba(88,214,141,0.1); color: #58d68d; border-color: rgba(88,214,141,0.2); }
    .alert-danger { background: rgba(255,108,108,0.1); color: #ff6c6c; border-color: rgba(255,108,108,0.2); }
</style>
{% endblock %}

{% block content %}
<div class="section">
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}success{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="form-section">
        <h3>üîç –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞</h3>
        <form method="GET" action="{% url 'admin_orders_editor' %}">
            <div class="form-row">
                <div class="form-group">
                    <label>ID –∑–∞–∫–∞–∑–∞ (ID –∏–ª–∏ External ID)</label>
                    <input class="form-control" type="text" name="order_id_search" 
                           value="{{ request.GET.order_id_search|default:'' }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä...">
                </div>
                <div class="form-group">
                    <label>–ë–∏—Ä–∂–∞ –ø–æ–∏—Å–∫–∞</label>
                    <select class="form-select">
                        <option>Bybit</option>
                        <option>HTX</option>
                        <option>MEXC</option>
                    </select>
                </div>
                <div class="form-group d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-blue w-100" style="height: 38px;">–ù–∞–π—Ç–∏</button>
                </div>
            </div>
        </form>
    </div>

    {% if order %}
    <div class="form-section">
        <h3>üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ #{{ order.id }}</h3>
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="target_order_pk" value="{{ order.pk }}">
            
            <div class="form-row">
                <div class="form-group">
                    <label>External ID</label>
                    <input class="form-control" type="text" name="external_id" value="{{ order.external_id|default:'' }}">
                </div>
                <div class="form-group">
                    <label>–í–ª–∞–¥–µ–ª–µ—Ü (–Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å)</label>
                    <div class="info-field">{{ order.user.username }}</div>
                </div>
                <div class="form-group">
                    <label>–ë–∏—Ä–∂–∞ –∑–∞–∫–∞–∑–∞</label>
                    <select class="form-select" name="exchange_type">
                        <option value="1" {% if order.exchange_type == 1 or order.exchange_type == '1' %}selected{% endif %}>Bybit</option>
                        <option value="2" {% if order.exchange_type == 2 or order.exchange_type == '2' %}selected{% endif %}>HTX</option>
                        <option value="3" {% if order.exchange_type == 3 or order.exchange_type == '3' %}selected{% endif %}>MEXC</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
                    <select class="form-select" name="operation_type">
                        <option value="BUY" {% if order.operation_type == 'BUY' %}selected{% endif %}>–ü–æ–∫—É–ø–∫–∞ (BUY)</option>
                        <option value="SELL" {% if order.operation_type == 'SELL' %}selected{% endif %}>–ü—Ä–æ–¥–∞–∂–∞ (SELL)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ë–∞–Ω–∫ </label>
                    <select class="form-select" name="bank_detail_id">
                        <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
                        {% for detail in user_details %}
                            <option value="{{ detail.id }}" {% if order.bank_detail_id == detail.id %}selected{% endif %}>
                                {{ detail.name }} ({{ detail.card_number|slice:"-4:" }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
                    <input class="form-control" type="datetime-local" name="created_at" value="{{ order.created_at|date:'Y-m-d\TH:i' }}">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>–¶–µ–Ω–∞</label>
                    <input class="form-control" type="number" name="price" step="0.01" value="{{ order.price|stringformat:'.2f' }}">
                </div>
                <div class="form-group">
                    <label>–°—É–º–º–∞</label>
                    <input class="form-control" type="number" name="amount" step="0.01" value="{{ order.amount|stringformat:'.2f' }}">
                </div>
                <div class="form-group">
                    <label>–û–±—ä–µ–º (USDT)</label>
                    <input class="form-control" type="number" name="cost" step="0.00000001" value="{{ order.cost|stringformat:'.8f' }}">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>–ö–æ–º–∏—Å—Å–∏—è</label>
                    <input class="form-control" type="number" name="commission" step="0.01" value="{{ order.commission|default:'0.00' }}">
                </div>
                <div class="form-group">
                    <label>–¢–∏–ø –∫–æ–º–∏—Å—Å–∏–∏</label>
                    <select class="form-select" name="commission_type">
                        <option value="PERCENT" {% if order.commission_type == 'PERCENT' %}selected{% endif %}>–ü—Ä–æ—Ü–µ–Ω—Ç</option>
                        <option value="MONEY" {% if order.commission_type == 'MONEY' %}selected{% endif %}>–î–µ–Ω—å–≥–∏</option>
                    </select>
                </div>
                <div class="form-group d-flex align-items-end">
                    <button type="submit" name="save_order" class="btn btn-outline-blue w-100" style="height: 38px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </form>
    </div>
    {% endif %}

    <div class="form-section">
        <h3>üìä –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞</h3>
        <div class="form-row">
            <div class="form-group">
                <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                <select class="form-select"><option>–í—Å–µ</option></select>
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞ —Å</label>
                <input class="form-control" type="date">
            </div>
            <div class="form-group d-flex align-items-end">
                <button class="btn btn-outline-success w-100" style="height: 38px;">üì• –°–∫–∞—á–∞—Ç—å Excel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
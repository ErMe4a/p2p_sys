{% extends 'admin/admin_base.html' %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | –ê–¥–º–∏–Ω–∫–∞{% endblock %}

{% block extra_css %}
<style>
    .form-control { background: var(--bg-input) !important; border: 1px solid var(--border-color) !important; color: #fff !important; }
    .api-label { display: inline-flex; align-items: center; gap: 5px; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: var(--bg-input); border: 1px solid var(--border-color); }
    .api-label.active { color: #58d68d; border-color: rgba(88,214,141,0.3); }
    .api-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; background: #3a3a4a; }
    .api-dot.active { background: #58d68d; box-shadow: 0 0 5px #58d68d; }
    
    .form-section-inner { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color); margin-bottom: 15px; }
    .form-section-inner h4 { font-size: 0.85rem; margin-bottom: 12px; color: var(--accent-blue); display: flex; align-items: center; gap: 8px; }
    .indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: #3a3a4a; }
    .indicator.ok { background: #58d68d; box-shadow: 0 0 5px #58d68d; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-group label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Ç—á–µ—Ç–∞ */
    .btn-report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .btn-full-width { grid-column: span 2; }
</style>
{% endblock %}

{% block content %}
<div class="card-custom">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="m-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h5>
        <button class="btn btn-sm btn-outline-blue px-3" onclick="openAddUserModal()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle" style="color: var(--text-main); border-color: var(--border-color);">
            <thead style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">
                <tr>
                    <th>ID</th>
                    <th>–õ–æ–≥–∏–Ω</th>
                    <th>Bybit</th>
                    <th>HTX</th>
                    <th>Evotor</th>
                    <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody style="font-size: 0.85rem;">
                {% for u in users %}
                <tr>
                    <td class="text-muted">{{ u.id }}</td>
                    <td class="fw-bold">{{ u.username }}</td>
                    <td>
                        <span class="api-label {% if u.bybit_api_key %}active{% endif %}">
                            <span class="api-dot {% if u.bybit_api_key %}active{% endif %}"></span>
                            {% if u.bybit_api_key %}‚úì{% else %}‚Äî{% endif %}
                        </span>
                    </td>
                    <td>
                        <span class="api-label {% if u.htx_access_key %}active{% endif %}">
                            <span class="api-dot {% if u.htx_access_key %}active{% endif %}"></span>
                            {% if u.htx_access_key %}‚úì{% else %}‚Äî{% endif %}
                        </span>
                    </td>
                    <td>
                        <span class="api-label {% if u.evotor_login %}active{% endif %}">
                            <span class="api-dot {% if u.evotor_login %}active{% endif %}"></span>
                            {% if u.evotor_login %}‚úì{% else %}‚Äî{% endif %}
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-secondary" 
                                onclick="openEditUserModal('{{ u.id }}', '{{ u.username }}', '{{ u.bybit_api_key|default:'' }}', '{{ u.bybit_api_secret|default:'' }}', '{{ u.htx_access_key|default:'' }}', '{{ u.htx_private_key|default:'' }}', '{{ u.evotor_login|default:'' }}', '{{ u.evotor_password|default:'' }}')">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-1" onclick="openReportsModal('{{ u.id }}', '{{ u.username }}')">
                            üìä
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal-overlay" id="addUserModal">
    <div class="modal-content-custom" style="max-width: 500px;">
        <div class="modal-header-custom">
            <span>–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
            <button class="btn-close btn-close-white" onclick="closeAddUserModal()"></button>
        </div>
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_user">
            <div class="form-row mb-3">
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω *</label>
                    <input class="form-control" type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å *</label>
                    <input class="form-control" type="password" name="password" required>
                </div>
            </div>
            <div style="display:flex; gap:12px; justify-content:flex-end;">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closeAddUserModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-sm btn-outline-blue px-4">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="editUserModal">
    <div class="modal-content-custom">
        <div class="modal-header-custom">
            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: <strong id="editUserLoginLabel" class="text-primary"></strong></span>
            <button class="btn-close btn-close-white" onclick="closeEditUserModal()"></button>
        </div>
        <form id="editUserForm" method="POST">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit_user">
            <input type="hidden" name="user_id" id="editUserId">
            
            <div class="form-section-inner">
                <h4><span id="bybitInd" class="indicator"></span> Bybit API</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>API Key</label>
                        <input class="form-control" type="text" name="bybit_key" id="editBybitKey">
                    </div>
                    <div class="form-group">
                        <label>API Secret</label>
                        <input class="form-control" type="text" name="bybit_secret" id="editBybitSecret">
                    </div>
                </div>
            </div>

            <div class="form-section-inner">
                <h4><span id="htxInd" class="indicator"></span> HTX API</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Access Key</label>
                        <input class="form-control" type="text" name="htx_key" id="editHtxKey">
                    </div>
                    <div class="form-group">
                        <label>Private Key</label>
                        <input class="form-control" type="text" name="htx_secret" id="editHtxSecret">
                    </div>
                </div>
            </div>

            <div class="form-section-inner">
                <h4><span id="evoInd" class="indicator"></span> Evotor</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>–õ–æ–≥–∏–Ω</label>
                        <input class="form-control" type="text" name="evotor_login" id="editEvoLogin">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input class="form-control" type="password" name="evotor_password" id="editEvoPass">
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:10px;">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closeEditUserModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-sm btn-outline-blue px-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="reportsModal">
    <div class="modal-content-custom" style="max-width: 500px;">
        <div class="modal-header-custom">
            <span>üìä –û—Ç—á—ë—Ç—ã ‚Äî <strong id="reportsUserLogin" class="text-primary"></strong></span>
            <button class="btn-close btn-close-white" onclick="closeReportsModal()"></button>
        </div>
        
        <input type="hidden" id="reportsUserId">
        
        <div class="form-group mb-3">
            <label>–†–µ–∫–≤–∏–∑–∏—Ç—ã</label>
            <select class="form-control" id="reportsUserDetails">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</option>
            </select>
        </div>

        <div class="form-row mb-3">
            <div class="form-group">
                <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                <input class="form-control" type="date" id="reportsStartDate">
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                <input class="form-control" type="date" id="reportsEndDate">
            </div>
        </div>

        <div class="form-row mb-3">
            <div class="form-group">
                <label>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
                <select class="form-control" id="reportsOperationType">
                    <option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
                    <option value="BUY">–ü–æ–∫—É–ø–∫–∞ (BUY)</option>
                    <option value="SELL">–ü—Ä–æ–¥–∞–∂–∞ (SELL)</option>
                </select>
            </div>
            <div class="form-group">
                <label>–ì–æ–¥ (–¥–ª—è –£–°–ù)</label>
                <input class="form-control" type="number" id="reportsYear" value="2026" min="2020" max="2030">
            </div>
        </div>

        <div class="btn-report-grid">
            <button type="button" class="btn btn-sm btn-outline-blue" onclick="downloadScreenshots()" id="downloadScreenshotsBtn">üì∑ –°–∫—Ä–∏–Ω—à–æ—Ç—ã</button>
            <button type="button" class="btn btn-sm btn-outline-blue" onclick="downloadExcel()" id="downloadExcelBtn">üìä Excel</button>
            <button type="button" class="btn btn-sm btn-outline-blue btn-full-width" onclick="downloadUsn()" id="downloadUsnBtn">üìã –°–∫–∞—á–∞—Ç—å –£–°–ù –æ—Ç—á–µ—Ç</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª–∫–∞–º–∏
    function openAddUserModal() { document.getElementById('addUserModal').classList.add('active'); }
    function closeAddUserModal() { document.getElementById('addUserModal').classList.remove('active'); }

    function openEditUserModal(id, login, bKey, bSec, hKey, hSec, eLog, ePass) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editUserLoginLabel').innerText = login;
        document.getElementById('editBybitKey').value = bKey;
        document.getElementById('editBybitSecret').value = bSec;
        document.getElementById('editHtxKey').value = hKey;
        document.getElementById('editHtxSecret').value = hSec;
        document.getElementById('editEvoLogin').value = eLog;
        document.getElementById('editEvoPass').value = ePass;
        document.getElementById('bybitInd').className = bKey ? 'indicator ok' : 'indicator';
        document.getElementById('htxInd').className = hKey ? 'indicator ok' : 'indicator';
        document.getElementById('evoInd').className = eLog ? 'indicator ok' : 'indicator';
        document.getElementById('editUserModal').classList.add('active');
    }

    function closeEditUserModal() { document.getElementById('editUserModal').classList.remove('active'); }

    // –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª–∫–∏ –û–¢–ß–ï–¢–û–í
    const availableBanks = [
        { id: 'sber', name: '–°–±–µ—Ä–±–∞–Ω–∫' },
        { id: 'tinkoff', name: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ' },
        { id: 'alfa', name: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫' },
        { id: 'vtb', name: '–í–¢–ë' },
        { id: 'raiff', name: '–†–∞–π—Ñ—Ñ–∞–π–∑–µ–Ω' }
    ];

    function openReportsModal(userId, username) {
        document.getElementById('reportsUserId').value = userId;
        document.getElementById('reportsUserLogin').innerText = username;
        
        const detailsSelect = document.getElementById('reportsUserDetails');
        
        // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑ –Ω–∞—à–µ–≥–æ –º–∞—Å—Å–∏–≤–∞
        detailsSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</option>';
        
        availableBanks.forEach(bank => {
            let opt = document.createElement('option');
            opt.value = bank.id;
            opt.innerHTML = bank.name;
            detailsSelect.appendChild(opt);
        });

        document.getElementById('reportsModal').classList.add('active');
    }

    function closeReportsModal() { 
        document.getElementById('reportsModal').classList.remove('active'); 
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (—Ñ–æ—Ä–º–∏—Ä—É—é—Ç URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ —Ñ–æ—Ä–º—ã)
    function downloadExcel() {
        const userId = document.getElementById('reportsUserId').value;
        const start = document.getElementById('reportsStartDate').value;
        const end = document.getElementById('reportsEndDate').value;
        const bank = document.getElementById('reportsUserDetails').value;
        const type = document.getElementById('reportsOperationType').value;

        if (!start || !end) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–∞—Ç');
            return;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥
        const url = `/admin-panel/export/excel/?user_id=${userId}&start=${start}&end=${end}&bank=${bank}&type=${type}`;
        window.location.href = url;
    }

    function downloadUsn() {
        const userId = document.getElementById('reportsUserId').value;
        const year = document.getElementById('reportsYear').value;
        window.location.href = `/admin-panel/export/usn/?user_id=${userId}&year=${year}`;
    }

    function downloadScreenshots() {
        const userId = document.getElementById('reportsUserId').value;
        alert('–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±–æ—Ä –∞—Ä—Ö–∏–≤–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ID: ' + userId);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
    window.onclick = function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            closeAddUserModal();
            closeEditUserModal();
            closeReportsModal();
        }
    }
</script>
{% endblock %}